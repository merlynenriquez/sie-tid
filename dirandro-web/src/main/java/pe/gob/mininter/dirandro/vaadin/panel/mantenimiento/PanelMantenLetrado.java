package pe.gob.mininter.dirandro.vaadin.panel.mantenimiento;

import java.text.MessageFormat;
import java.util.List;

import org.apache.commons.lang.StringUtils;

import pe.gob.mininter.dirandro.model.Letrado;
import pe.gob.mininter.dirandro.model.Opcion;
import pe.gob.mininter.dirandro.model.Persona;
import pe.gob.mininter.dirandro.model.Valor;
import pe.gob.mininter.dirandro.service.LetradoService;
import pe.gob.mininter.dirandro.service.PersonaService;
import pe.gob.mininter.dirandro.util.Constante;
import pe.gob.mininter.dirandro.vaadin.dialogs.AlertDialog;
import pe.gob.mininter.dirandro.vaadin.panel.util.PanelAgregarPersona;
import pe.gob.mininter.dirandro.vaadin.util.ComboBoxLOVS;
import pe.gob.mininter.dirandro.vaadin.util.DirandroComponent;
import pe.gob.mininter.dirandro.vaadin.util.Injector;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.Property.ValueChangeListener;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.event.FieldEvents.TextChangeEvent;
import com.vaadin.event.FieldEvents.TextChangeListener;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextField;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class PanelMantenLetrado extends DirandroComponent implements TextChangeListener,ClickListener {
	
	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private HorizontalLayout pnlPrincipal;
	@AutoGenerated
	private VerticalLayout pnlDatos;
	@AutoGenerated
	private HorizontalLayout horizontalLayout_2;
	@AutoGenerated
	private Button btnEliminar;
	@AutoGenerated
	private Button btnAgregar;
	@AutoGenerated
	private TextField txtColegiatura;
	@AutoGenerated
	private ComboBoxLOVS cmbTipo;
	@AutoGenerated
	private HorizontalLayout pnlDatos2;
	@AutoGenerated
	private Label lblDatosPersona;
	@AutoGenerated
	private HorizontalLayout horizontalLayout_4;
	@AutoGenerated
	private Button btnNuevo;
	@AutoGenerated
	private ComboBox cmbNombres;
	@AutoGenerated
	private Label lblLetrado;
	@AutoGenerated
	private VerticalLayout pnlLista;
	@AutoGenerated
	private Table tblLetrados;
	@AutoGenerated
	private HorizontalLayout horizontalLayout_1;
	@AutoGenerated
	private TextField txtfiltroNroDniLetrado;
	@AutoGenerated
	private TextField txtfiltroNomLetrado;
	@AutoGenerated
	private Label lblFiltro;
	
	private static final long serialVersionUID = -2300724647915630886L;
	
	private List<Persona> lstPersonas;
	private PanelAgregarPersona pnlAgregarPersona;
	private LetradoService letradoService;	
	private PersonaService personaService;
	private boolean flagNuevaEstado;
	private Long idLetrado;
	private Persona personaPopUp;
		
	public Persona getPersonaPopUp() {
		return personaPopUp;
	}

	public void setPersonaPopUp(Persona personaPopUp) {
		this.personaPopUp = personaPopUp;
	}
	
	public PanelMantenLetrado(List<Opcion> acciones, String height) {
		super(acciones, height);
		buildMainLayout();
		setCompositionRoot(mainLayout);
		letradoService = Injector.obtenerServicio(LetradoService.class);		
		personaService = Injector.obtenerServicio(PersonaService.class);
		postConstruct();
	}
	
	public void postConstruct() {
		
		btnNuevo.addListener((ClickListener)this);
		btnAgregar.addListener((ClickListener)this);
		btnNuevo.setIcon(Constante.ICONOS.CREATE);

		cmbTipo.setCodigoLista(Constante.LISTA.CODIGO.TIPO_LETRADO);
		cmbTipo.setInputPrompt("Tipo de Letrado");
		
		pnlDatos2.setEnabled(false);
		pnlDatos2.setVisible(false);
		
		cargaLista();
		habilitarEdicion(false);
		
		txtfiltroNomLetrado.addListener((TextChangeListener)this);
		txtfiltroNroDniLetrado.addListener((TextChangeListener)this);
		
		tblLetrados.setSelectable(true);
		tblLetrados.setImmediate(true);
		tblLetrados.setNullSelectionAllowed(true);
		tblLetrados.setNullSelectionItemId(null);
		tblLetrados.addListener(new ValueChangeListener() {
			
			private static final long serialVersionUID = 7962790507398071986L;

			@Override
			public void valueChange(ValueChangeEvent event) {
				boolean esModoNuevo = tblLetrados.getValue() == null;
				limpiar();
				if(esModoNuevo){
					tblLetrados.setValue(null);
					habilitarEdicion(false);
					pnlDatos2.setVisible(false);
				}
				else{
					pnlDatos2.setVisible(true);
					habilitarEdicion(true);
					Item item = tblLetrados.getItem(tblLetrados.getValue());
					idLetrado = (Long) item.getItemProperty("id").getValue();
					txtColegiatura.setValue(item.getItemProperty("nroColegiatura").getValue());
					cmbTipo.select(new Valor((Long) item.getItemProperty("tipo.id").getValue()));
					cmbNombres.select((Persona) item.getItemProperty("representante").getValue());
				}
			}
		});	
		refrescar();
	}
	
	public void refrescar(){
		habilitarEdicion(false);
		limpiar();
		cargarLetrados(letradoService.listarLetrado());
	}
	
	public void cargaLista(){
		lstPersonas = personaService.buscar(null);
		cmbNombres.setInputPrompt("Persona");
		cmbNombres.setItemCaptionPropertyId("nombreCompleto");
		cmbNombres.setImmediate(true);
		cmbNombres.setContainerDataSource(new BeanItemContainer<Persona>(Persona.class, lstPersonas));
		
		cmbNombres.addListener( new ValueChangeListener() {
			
			private static final long serialVersionUID = -6213576334461528840L;

			@Override
			public void valueChange(ValueChangeEvent event) {
				pnlDatos2.setVisible(true);
				
				if( cmbNombres.getValue() != null)
					imprimirPersona((Persona)cmbNombres.getValue());
			}						
		});
	}
	
	private void habilitarEdicion(boolean flag){
		flagNuevaEstado = flag;
		if(flag){
			btnAgregar.setCaption("Actualizar");
		}
		else{
			btnAgregar.setCaption("Crear");
		}
	}
	
	private void cargarLetrados(List<Letrado> listLetrado){
		IndexedContainer container = new IndexedContainer();
		container.addContainerProperty("id", Long.class,  null);
		container.addContainerProperty("nombres", String.class, null);
		container.addContainerProperty("ape_paterno", String.class, null);
		container.addContainerProperty("nro_documento", String.class, null);
		container.addContainerProperty("nroColegiatura", String.class, null);
		container.addContainerProperty("tipo", Valor.class, null);
		container.addContainerProperty("tipo.id", Long.class, null);
		container.addContainerProperty("persona", Persona.class, null);
		container.addContainerProperty("persona.id", Long.class, null);
		container.addContainerProperty("persona.tipoDocumento", String.class, null);
		container.addContainerProperty("persona.nroDocumento", String.class, null);
		container.addContainerProperty("persona.sexo", String.class, null);
		container.addContainerProperty("persona.nacionalidad", String.class, null);
		
		tblLetrados.setContainerDataSource(container);
		tblLetrados.setVisibleColumns(new Object[]{"nombres", "nroColegiatura"});
				
		tblLetrados.setColumnHeader("nombres", "Nombre Completo");
		tblLetrados.setColumnHeader("nroColegiatura", "Nro de Colegiatura");
		
		int con=1;
		for (Letrado letrado : listLetrado){
			Item item = container.addItem(con++);
			item.getItemProperty("id").setValue(letrado.getId());
			item.getItemProperty("persona").setValue(letrado.getPersona());
			item.getItemProperty("persona.id").setValue(letrado.getPersona().getId());
			item.getItemProperty("nombres").setValue(letrado.getPersona().getNombreCompleto());
			item.getItemProperty("ape_paterno").setValue(letrado.getPersona().getApePaterno());
			item.getItemProperty("nro_documento").setValue(letrado.getPersona().getNroDocumento());
			item.getItemProperty("persona.tipoDocumento").setValue(letrado.getPersona().getTipoDocumento() != null ? letrado.getPersona().getTipoDocumento().getNombre() : StringUtils.EMPTY);
			item.getItemProperty("persona.nroDocumento").setValue(letrado.getPersona().getNroDocumento() != null ? letrado.getPersona().getNroDocumento().toString() : StringUtils.EMPTY);
			item.getItemProperty("persona.sexo").setValue(letrado.getPersona().getSexo() != null ? letrado.getPersona().getSexo().toString() : StringUtils.EMPTY);
			item.getItemProperty("persona.nacionalidad").setValue(letrado.getPersona().getNacionalidad() != null ? letrado.getPersona().getNacionalidad().getNombre() : StringUtils.EMPTY);
			item.getItemProperty("nroColegiatura").setValue(letrado.getNroColegiatura());
			item.getItemProperty("tipo").setValue(letrado.getTipo());
			item.getItemProperty("tipo.id").setValue(letrado.getTipo().getId());
		}
	}
	
	 public void obtenerDatosPersona() {
		 lstPersonas = personaService.buscar(null);
         cmbNombres.setContainerDataSource(new BeanItemContainer<Persona>(Persona.class, lstPersonas));
         cmbNombres.select(personaPopUp);
	 }
	 
	 private void imprimirPersona(Persona persona) {
		String plantilla = "<p><b>Tipo y Número de Documento:</b> {0} {1} <b>Nacionalidad:</b> {2} <b>Sexo:</b> {3}</p>";
		lblDatosPersona.setVisible(true);
		String sexoPersona = persona.getSexo().equals("M") ? "Masculino" : "Femenino";
		String html = MessageFormat.format(plantilla, persona.getTipoDocumento().getNombre(), persona.getNroDocumento(), persona.getNacionalidad().getNombre(), sexoPersona);
		lblDatosPersona.setValue(html);
	}
		
	private void cargarWindowPersona(Persona persona) {
		pnlAgregarPersona = new PanelAgregarPersona(this, persona);
		pnlAgregarPersona.setParent(this.getParent());
		
		final Window window=new Window(){
			
			private static final long serialVersionUID = 1L;

			protected void close() {
		    	getApplication().getMainWindow().removeWindow(getWindow());
			}
		};
		      
		window.setCaption("Registrar Persona");
		window.addComponent(pnlAgregarPersona);
		window.setModal(true);
		window.setResizable(false);
		window.setWidth("650px");
		window.setHeight("-1.0");
		getApplication().getMainWindow().addWindow(window);
		
	}
		
	@Override
	public void buttonClick(ClickEvent event) {
		
		if (event.getButton().equals(btnNuevo)) {
			cargarWindowPersona(new Persona());
		}else if (event.getButton().equals(btnAgregar)) {	
			StringBuilder sbContenido = new StringBuilder();
			Letrado letrado =  new Letrado();
			letrado.setPersona((Persona) cmbNombres.getValue());
			letrado.setTipo((Valor) cmbTipo.getValue());
			letrado.setNroColegiatura(txtColegiatura.getValue().toString());
			letrado.validar();
			if(flagNuevaEstado){
				letrado.setId(idLetrado);
				letradoService.actualizar(letrado);
				sbContenido.append("Letrado : ").append(letrado.getPersona().getNombreCompleto()).append(" se ha "+ Constante.OPERACION.ACTUALIZAR_REGISTRO+" satisfactoriamente.");
			}
			else{
				sbContenido.append("Letrado : ").append(letrado.getPersona().getNombreCompleto()).append(" se ha "+ Constante.OPERACION.CREAR_REGISTRO+" satisfactoriamente.");
				letradoService.crear(letrado);
			}
			
			AlertDialog alertDialog = new  AlertDialog("Letrado", sbContenido.toString(), "Aceptar", "400");
			getApplication().getMainWindow().addWindow(alertDialog);
			refrescar();
		}
	}
	
	private void limpiar(){
		cmbNombres.select(null);
		cmbTipo.select(null);
		txtColegiatura.setValue("");
		idLetrado = null;
	}	
	
	@Override
	public void textChange(TextChangeEvent event) {
		Letrado letrado = new Letrado();
		letrado.setPersona(new Persona());		
		
		if (event.getSource().equals(txtfiltroNomLetrado)) {
			letrado.getPersona().setNombres(event.getText());
		}
		else if (event.getSource().equals(txtfiltroNroDniLetrado)) {		
			letrado.getPersona().setNroDocumento(event.getText());					
		}
	}

	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("100%");
		mainLayout.setHeight("-1px");
		mainLayout.setMargin(true);
		
		// top-level component properties
		setWidth("100.0%");
		setHeight("-1px");
		
		// pnlPrincipal
		pnlPrincipal = buildPnlPrincipal();
		mainLayout.addComponent(pnlPrincipal);
		mainLayout.setComponentAlignment(pnlPrincipal, new Alignment(20));
		
		return mainLayout;
	}

	@AutoGenerated
	private HorizontalLayout buildPnlPrincipal() {
		// common part: create layout
		pnlPrincipal = new HorizontalLayout();
		pnlPrincipal.setStyleName("whiteBackGround");
		pnlPrincipal.setImmediate(false);
		pnlPrincipal.setWidth("-1px");
		pnlPrincipal.setHeight("-1px");
		pnlPrincipal.setMargin(true);
		pnlPrincipal.setSpacing(true);
		
		// pnlLista
		pnlLista = buildPnlLista();
		pnlPrincipal.addComponent(pnlLista);
		
		// pnlDatos
		pnlDatos = buildPnlDatos();
		pnlPrincipal.addComponent(pnlDatos);
		pnlPrincipal.setComponentAlignment(pnlDatos, new Alignment(20));
		
		return pnlPrincipal;
	}

	@AutoGenerated
	private VerticalLayout buildPnlLista() {
		// common part: create layout
		pnlLista = new VerticalLayout();
		pnlLista.setImmediate(false);
		pnlLista.setWidth("460px");
		pnlLista.setHeight("-1px");
		pnlLista.setMargin(false);
		
		// lblFiltro
		lblFiltro = new Label();
		lblFiltro.setStyleName("h2");
		lblFiltro.setImmediate(false);
		lblFiltro.setWidth("157px");
		lblFiltro.setHeight("-1px");
		lblFiltro.setValue("Filtro de Letrados");
		pnlLista.addComponent(lblFiltro);
		
		// horizontalLayout_1
		horizontalLayout_1 = buildHorizontalLayout_1();
		pnlLista.addComponent(horizontalLayout_1);
		
		// tblLetrados
		tblLetrados = new Table();
		tblLetrados.setImmediate(false);
		tblLetrados.setWidth("450px");
		tblLetrados.setHeight("300px");
		pnlLista.addComponent(tblLetrados);
		
		return pnlLista;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_1() {
		// common part: create layout
		horizontalLayout_1 = new HorizontalLayout();
		horizontalLayout_1.setImmediate(false);
		horizontalLayout_1.setWidth("-1px");
		horizontalLayout_1.setHeight("-1px");
		horizontalLayout_1.setMargin(false);
		
		// txtfiltroNomLetrado
		txtfiltroNomLetrado = new TextField();
		txtfiltroNomLetrado.setImmediate(false);
		txtfiltroNomLetrado.setWidth("250px");
		txtfiltroNomLetrado.setHeight("-1px");
		txtfiltroNomLetrado.setInputPrompt("Nombres");
		horizontalLayout_1.addComponent(txtfiltroNomLetrado);
		
		// txtfiltroNroDniLetrado
		txtfiltroNroDniLetrado = new TextField();
		txtfiltroNroDniLetrado.setImmediate(false);
		txtfiltroNroDniLetrado.setWidth("200px");
		txtfiltroNroDniLetrado.setHeight("-1px");
		txtfiltroNroDniLetrado.setInputPrompt("Num de Colegiatura");
		horizontalLayout_1.addComponent(txtfiltroNroDniLetrado);
		
		return horizontalLayout_1;
	}

	@AutoGenerated
	private VerticalLayout buildPnlDatos() {
		// common part: create layout
		pnlDatos = new VerticalLayout();
		pnlDatos.setStyleName("h2");
		pnlDatos.setImmediate(false);
		pnlDatos.setWidth("-1px");
		pnlDatos.setHeight("-1px");
		pnlDatos.setMargin(false);
		pnlDatos.setSpacing(true);
		
		// lblLetrado
		lblLetrado = new Label();
		lblLetrado.setStyleName("h2");
		lblLetrado.setImmediate(false);
		lblLetrado.setWidth("187px");
		lblLetrado.setHeight("-1px");
		lblLetrado.setValue("Administración Letrado");
		pnlDatos.addComponent(lblLetrado);
		
		// horizontalLayout_4
		horizontalLayout_4 = buildHorizontalLayout_4();
		pnlDatos.addComponent(horizontalLayout_4);
		
		// pnlDatos2
		pnlDatos2 = buildPnlDatos2();
		pnlDatos.addComponent(pnlDatos2);
		
		// cmbTipo
		cmbTipo = new ComboBoxLOVS();
		cmbTipo.setImmediate(false);
		cmbTipo.setWidth("-1px");
		cmbTipo.setHeight("-1px");
		pnlDatos.addComponent(cmbTipo);
		
		// txtColegiatura
		txtColegiatura = new TextField();
		txtColegiatura.setCaption("N° de Colegiatura");
		txtColegiatura.setImmediate(false);
		txtColegiatura.setWidth("150px");
		txtColegiatura.setHeight("-1px");
		txtColegiatura.setInputPrompt("Nro de Colegiatura");
		pnlDatos.addComponent(txtColegiatura);
		
		// horizontalLayout_2
		horizontalLayout_2 = buildHorizontalLayout_2();
		pnlDatos.addComponent(horizontalLayout_2);
		
		return pnlDatos;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_4() {
		// common part: create layout
		horizontalLayout_4 = new HorizontalLayout();
		horizontalLayout_4.setImmediate(false);
		horizontalLayout_4.setWidth("-1px");
		horizontalLayout_4.setHeight("-1px");
		horizontalLayout_4.setMargin(false);
		horizontalLayout_4.setSpacing(true);
		
		// cmbNombres
		cmbNombres = new ComboBox();
		cmbNombres.setCaption("Nombre Apellido Letrado");
		cmbNombres.setImmediate(false);
		cmbNombres.setWidth("230px");
		cmbNombres.setHeight("-1px");
		cmbNombres.setRequired(true);
		horizontalLayout_4.addComponent(cmbNombres);
		
		// btnNuevo
		btnNuevo = new Button();
		btnNuevo.setCaption(" ");
		btnNuevo.setImmediate(true);
		btnNuevo.setWidth("-1px");
		btnNuevo.setHeight("-1px");
		horizontalLayout_4.addComponent(btnNuevo);
		horizontalLayout_4.setComponentAlignment(btnNuevo, new Alignment(24));
		
		return horizontalLayout_4;
	}

	@AutoGenerated
	private HorizontalLayout buildPnlDatos2() {
		// common part: create layout
		pnlDatos2 = new HorizontalLayout();
		pnlDatos2.setImmediate(false);
		pnlDatos2.setWidth("-1px");
		pnlDatos2.setHeight("-1px");
		pnlDatos2.setMargin(false);
		pnlDatos2.setSpacing(true);
		
		// lblDatosPersona
		lblDatosPersona = new Label();
		lblDatosPersona.setImmediate(false);
		lblDatosPersona.setWidth("270px");
		lblDatosPersona.setHeight("50px");
		lblDatosPersona.setValue(" ");
		lblDatosPersona.setContentMode(3);
		pnlDatos2.addComponent(lblDatosPersona);
		
		return pnlDatos2;
	}

	@AutoGenerated
	private HorizontalLayout buildHorizontalLayout_2() {
		// common part: create layout
		horizontalLayout_2 = new HorizontalLayout();
		horizontalLayout_2.setImmediate(false);
		horizontalLayout_2.setWidth("-1px");
		horizontalLayout_2.setHeight("-1px");
		horizontalLayout_2.setMargin(true);
		horizontalLayout_2.setSpacing(true);
		
		// btnAgregar
		btnAgregar = new Button();
		btnAgregar.setCaption("Agregar");
		btnAgregar.setImmediate(true);
		btnAgregar.setWidth("-1px");
		btnAgregar.setHeight("-1px");
		horizontalLayout_2.addComponent(btnAgregar);
		
		// btnEliminar
		btnEliminar = new Button();
		btnEliminar.setCaption("Eliminar");
		btnEliminar.setImmediate(true);
		btnEliminar.setWidth("-1px");
		btnEliminar.setHeight("-1px");
		horizontalLayout_2.addComponent(btnEliminar);
		
		return horizontalLayout_2;
	}
	

}
