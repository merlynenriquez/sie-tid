package pe.gob.mininter.dirandro.vaadin.panel;

import java.util.List;

import pe.gob.mininter.dirandro.model.DetExpedientePersona;
import pe.gob.mininter.dirandro.model.DetPerTelExp;
import pe.gob.mininter.dirandro.model.Numero;
import pe.gob.mininter.dirandro.model.Persona;
import pe.gob.mininter.dirandro.model.Valor;
import pe.gob.mininter.dirandro.service.ExpedientePersonaService;
import pe.gob.mininter.dirandro.service.ExpedienteService;
import pe.gob.mininter.dirandro.service.ExpedienteTelefonoService;
import pe.gob.mininter.dirandro.service.NumeroService;
import pe.gob.mininter.dirandro.service.PersonaService;
import pe.gob.mininter.dirandro.util.Constante;
import pe.gob.mininter.dirandro.vaadin.util.ComboBoxLOVS;
import pe.gob.mininter.dirandro.vaadin.util.Injector;

import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.Item;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.ui.AbstractSelect.Filtering;
import com.vaadin.ui.Alignment;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.CustomComponent;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.Table;
import com.vaadin.ui.TextArea;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;

public class PanelRegistroParteTelefono extends CustomComponent implements ClickListener {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */
	
	@AutoGenerated
	private VerticalLayout mainLayout;
	@AutoGenerated
	private VerticalLayout pnlPrincipal;
	@AutoGenerated
	private Table tblTelLista;
	@AutoGenerated
	private Button btnRegistrar;
	@AutoGenerated
	private TextArea txaObservacion;
	@AutoGenerated
	private HorizontalLayout pnlTelefonos2;
	@AutoGenerated
	private ComboBoxLOVS cmbOperadora;
	@AutoGenerated
	private ComboBoxLOVS cmbSituacion;
	@AutoGenerated
	private ComboBoxLOVS cmbEstado;
	@AutoGenerated
	private ComboBox cmbPropietario;
	@AutoGenerated
	private ComboBox cmbPersonaImplicada;
	@AutoGenerated
	private HorizontalLayout pnlTelefonos1;
	@AutoGenerated
	private Button btnRegistrarEquipo;
	@AutoGenerated
	private ComboBox cmbEquipo;
	@AutoGenerated
	private Button btnRegistrarTelefono;
	@AutoGenerated
	private ComboBox cmbNumeroTel;
	private static final long serialVersionUID = 5025374354898750230L;
	
	private ExpedientePersonaService expPersonaService;
	private NumeroService numeroService;
	private PersonaService personaService;
	private ExpedienteService expedienteService;
	private ExpedienteTelefonoService expTelefonoService;
	
	private List<Persona> lstPropietarios;
	private PanelAgregarTelefono pnlAgregarTelefono;
	
	public PanelRegistroParteTelefono() {
		buildMainLayout();
		expTelefonoService = Injector.obtenerServicio(ExpedienteTelefonoService.class);
		numeroService = Injector.obtenerServicio(NumeroService.class);
		personaService = Injector.obtenerServicio(PersonaService.class);
		expPersonaService = Injector.obtenerServicio(ExpedientePersonaService.class);
		expedienteService = Injector.obtenerServicio(ExpedienteService.class);
		setCompositionRoot(mainLayout);
		postConstruct();
	}
	
	public void postConstruct() {
		lstPropietarios =  personaService.buscar(null);
		cmbEquipo.setInputPrompt("Equipo Incautado");
		cmbEstado.setInputPrompt("Estado del Bien");
		cmbNumeroTel.setInputPrompt("Nro de Teléfono");
		cmbOperadora.setInputPrompt("Operadora");
		cmbPersonaImplicada.setInputPrompt("Persona Implicada con el Número");
		cmbPropietario.setInputPrompt("Propietario del Equipo");
		cmbSituacion.setInputPrompt("Situacion del Bien");
		
		cmbSituacion.setCodigoLista(Constante.LISTA.CODIGO.SITUACION_GENERAL);
		cmbEstado.setCodigoLista(Constante.LISTA.CODIGO.ESTADO_OBJETOS);
		cmbOperadora.setCodigoLista(Constante.LISTA.CODIGO.OPERADORA);
		
		btnRegistrar.addListener((ClickListener) this);
		btnRegistrarEquipo.addListener((ClickListener) this);
		
		cargarNumeros();
		cargarInvolucrados();		
		cargarInvolucrados(lstPropietarios);
		cargarExpTelefonos();
	}
	
	private void cargarNumeros() {
		List<Numero> lstNumeros = numeroService.buscar(null);
		cmbNumeroTel.setContainerDataSource(new BeanItemContainer<Numero>(Numero.class,  lstNumeros));
		cmbNumeroTel.setItemCaptionPropertyId("numero");
		cmbNumeroTel.setFilteringMode(Filtering.FILTERINGMODE_CONTAINS);
	}

	private void cargarInvolucrados() {
		List<DetExpedientePersona> lstInvolucrados = expPersonaService.buscar(null);
		cmbPersonaImplicada.setContainerDataSource(new BeanItemContainer<DetExpedientePersona>(DetExpedientePersona.class,  lstInvolucrados));
		cmbPersonaImplicada.setItemCaptionPropertyId("nombreCompleto");
		cmbPersonaImplicada.setFilteringMode(Filtering.FILTERINGMODE_CONTAINS);
	}
	
	private void cargarInvolucrados(List<Persona> lstInvolucrados){
		cmbPropietario.setContainerDataSource(new BeanItemContainer<Persona>(Persona.class,  lstInvolucrados));
		cmbPropietario.setItemCaptionPropertyId("nombreCompleto");
		cmbPropietario.setFilteringMode(Filtering.FILTERINGMODE_CONTAINS);
		cmbPropietario.setImmediate(true);
	}
	
	private void cargarExpTelefonos(){
		List<DetPerTelExp> lstExTelefonos = expTelefonoService.buscar(null);
		cargarExpTelefonos(lstExTelefonos);
	}

	private void cargarExpTelefonos(List<DetPerTelExp> lstExpTelefonos) {
		IndexedContainer container = new IndexedContainer();
		container.addContainerProperty("id", Long.class,  null);
		container.addContainerProperty("numero", Numero.class, null);
		container.addContainerProperty("implicado", DetExpedientePersona.class, null);
		container.addContainerProperty("implicado.nombre", String.class, null);
		container.addContainerProperty("operadora", Valor.class, null);
		container.addContainerProperty("operadora.nombre", String.class, null);
		container.addContainerProperty("situacion", Valor.class, null);
		container.addContainerProperty("situacion.nombre", String.class, null);
		container.addContainerProperty("estado", Valor.class, null);
		container.addContainerProperty("estado.nombre", String.class, null);
		
		tblTelLista.setContainerDataSource(container);
		tblTelLista.setVisibleColumns(new Object[]{"id","implicado.nombre","operadora.nombre","situacion.nombre","estado.nombre"});
		
		int con=1;
		for (DetPerTelExp expTelefono : lstExpTelefonos){
			Item item = container.addItem(con++);
			item.getItemProperty("id").setValue(expTelefono.getId());
			item.getItemProperty("implicado.nombre").setValue(expTelefono.getImplicado().getNombreCompleto());
			item.getItemProperty("operadora.nombre").setValue(expTelefono.getOperadora().getNombre());
			item.getItemProperty("situacion.nombre").setValue(expTelefono.getSituacion().getNombre());
			item.getItemProperty("estado.nombre").setValue(expTelefono.getEstado().getNombre());
		}
	}

	@Override
	public void buttonClick(ClickEvent event) {
		if(event.getButton().equals(btnRegistrarEquipo)){
			
			pnlAgregarTelefono = new PanelAgregarTelefono();
			Window window=new Window(){
				
				private static final long serialVersionUID = 1L;

				  protected void close() {
					  getApplication().getMainWindow().removeWindow(getWindow());
				  }};
			window.setCaption("Registrar Teléfono");
			window.addComponent(pnlAgregarTelefono);
			window.setModal(true);
			window.setResizable(false);
			window.setWidth("550px");
			window.setHeight("-1px");
			getWindow().addWindow(window);
			
		}
		if(event.getButton().equals(btnRegistrar)){
			DetPerTelExp detTelefono = new DetPerTelExp();
			detTelefono.setEstado((Valor) cmbEstado.getValue());
			detTelefono.setSituacion((Valor) cmbSituacion.getValue());
			detTelefono.setImplicado((DetExpedientePersona) cmbPersonaImplicada.getValue());
			detTelefono.setPropietario((Persona) cmbPropietario.getValue());
			detTelefono.setOperadora((Valor) cmbOperadora.getValue());
			detTelefono.setExpediente(expedienteService.obtener(1l));
			detTelefono.setNumeroTelefonico((Numero) cmbNumeroTel.getValue());
			detTelefono.setObservacion(txaObservacion.getValue().toString());
			expTelefonoService.crear(detTelefono);
		}
	}
	
	@AutoGenerated
	private VerticalLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new VerticalLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("-1px");
		mainLayout.setHeight("-1px");
		mainLayout.setMargin(false);
		
		// top-level component properties
		setWidth("-1px");
		setHeight("-1px");
		
		// pnlPrincipal
		pnlPrincipal = buildPnlPrincipal();
		mainLayout.addComponent(pnlPrincipal);
		mainLayout.setComponentAlignment(pnlPrincipal, new Alignment(20));
		
		return mainLayout;
	}

	@AutoGenerated
	private VerticalLayout buildPnlPrincipal() {
		// common part: create layout
		pnlPrincipal = new VerticalLayout();
		pnlPrincipal.setImmediate(false);
		pnlPrincipal.setWidth("-1px");
		pnlPrincipal.setHeight("-1px");
		pnlPrincipal.setMargin(true);
		pnlPrincipal.setSpacing(true);
		
		// pnlTelefonos1
		pnlTelefonos1 = buildPnlTelefonos1();
		pnlPrincipal.addComponent(pnlTelefonos1);
		
		// pnlTelefonos2
		pnlTelefonos2 = buildPnlTelefonos2();
		pnlPrincipal.addComponent(pnlTelefonos2);
		
		// txaObservacion
		txaObservacion = new TextArea();
		txaObservacion.setCaption("Observación");
		txaObservacion.setImmediate(false);
		txaObservacion.setWidth("900px");
		txaObservacion.setHeight("70px");
		txaObservacion
				.setInputPrompt("Observaciones adicionales al Equipo o Numero Incautado");
		pnlPrincipal.addComponent(txaObservacion);
		
		// btnRegistrar
		btnRegistrar = new Button();
		btnRegistrar.setCaption("Registrar");
		btnRegistrar.setImmediate(true);
		btnRegistrar.setWidth("-1px");
		btnRegistrar.setHeight("-1px");
		pnlPrincipal.addComponent(btnRegistrar);
		pnlPrincipal.setComponentAlignment(btnRegistrar, new Alignment(20));
		
		// tblTelLista
		tblTelLista = new Table();
		tblTelLista.setImmediate(false);
		tblTelLista.setWidth("900px");
		tblTelLista.setHeight("400px");
		pnlPrincipal.addComponent(tblTelLista);
		
		return pnlPrincipal;
	}

	@AutoGenerated
	private HorizontalLayout buildPnlTelefonos1() {
		// common part: create layout
		pnlTelefonos1 = new HorizontalLayout();
		pnlTelefonos1.setImmediate(false);
		pnlTelefonos1.setWidth("-1px");
		pnlTelefonos1.setHeight("-1px");
		pnlTelefonos1.setMargin(false);
		pnlTelefonos1.setSpacing(true);
		
		// cmbNumeroTel
		cmbNumeroTel = new ComboBox();
		cmbNumeroTel.setCaption("Nro Telefónico");
		cmbNumeroTel.setImmediate(false);
		cmbNumeroTel.setWidth("250px");
		cmbNumeroTel.setHeight("-1px");
		cmbNumeroTel.setRequired(true);
		pnlTelefonos1.addComponent(cmbNumeroTel);
		
		// btnRegistrarTelefono
		btnRegistrarTelefono = new Button();
		btnRegistrarTelefono.setCaption("Agregar Número");
		btnRegistrarTelefono.setImmediate(true);
		btnRegistrarTelefono.setWidth("-1px");
		btnRegistrarTelefono.setHeight("-1px");
		pnlTelefonos1.addComponent(btnRegistrarTelefono);
		pnlTelefonos1.setComponentAlignment(btnRegistrarTelefono,
				new Alignment(10));
		
		// cmbEquipo
		cmbEquipo = new ComboBox();
		cmbEquipo.setCaption("Equipo Telefónico");
		cmbEquipo.setImmediate(false);
		cmbEquipo.setWidth("200px");
		cmbEquipo.setHeight("-1px");
		pnlTelefonos1.addComponent(cmbEquipo);
		
		// btnRegistrarEquipo
		btnRegistrarEquipo = new Button();
		btnRegistrarEquipo.setCaption("Agregar Equipo");
		btnRegistrarEquipo.setImmediate(true);
		btnRegistrarEquipo.setWidth("-1px");
		btnRegistrarEquipo.setHeight("-1px");
		pnlTelefonos1.addComponent(btnRegistrarEquipo);
		pnlTelefonos1.setComponentAlignment(btnRegistrarEquipo, new Alignment(
				10));
		
		return pnlTelefonos1;
	}

	@AutoGenerated
	private HorizontalLayout buildPnlTelefonos2() {
		// common part: create layout
		pnlTelefonos2 = new HorizontalLayout();
		pnlTelefonos2.setImmediate(false);
		pnlTelefonos2.setWidth("-1px");
		pnlTelefonos2.setHeight("-1px");
		pnlTelefonos2.setMargin(false);
		pnlTelefonos2.setSpacing(true);
		
		// cmbPersonaImplicada
		cmbPersonaImplicada = new ComboBox();
		cmbPersonaImplicada.setCaption("Persona Implicada");
		cmbPersonaImplicada.setImmediate(false);
		cmbPersonaImplicada.setWidth("220px");
		cmbPersonaImplicada.setHeight("-1px");
		pnlTelefonos2.addComponent(cmbPersonaImplicada);
		
		// cmbPropietario
		cmbPropietario = new ComboBox();
		cmbPropietario.setCaption("Dueño");
		cmbPropietario.setImmediate(false);
		cmbPropietario.setWidth("220px");
		cmbPropietario.setHeight("-1px");
		pnlTelefonos2.addComponent(cmbPropietario);
		
		// cmbEstado
		cmbEstado = new ComboBoxLOVS();
		cmbEstado.setCaption("Estado");
		cmbEstado.setImmediate(false);
		cmbEstado.setWidth("120px");
		cmbEstado.setHeight("-1px");
		pnlTelefonos2.addComponent(cmbEstado);
		
		// cmbSituacion
		cmbSituacion = new ComboBoxLOVS();
		cmbSituacion.setCaption("Situación");
		cmbSituacion.setImmediate(false);
		cmbSituacion.setWidth("130px");
		cmbSituacion.setHeight("-1px");
		pnlTelefonos2.addComponent(cmbSituacion);
		
		// cmbOperadora
		cmbOperadora = new ComboBoxLOVS();
		cmbOperadora.setCaption("Operadora");
		cmbOperadora.setImmediate(false);
		cmbOperadora.setWidth("150px");
		cmbOperadora.setHeight("-1px");
		pnlTelefonos2.addComponent(cmbOperadora);
		
		return pnlTelefonos2;
	}
}
